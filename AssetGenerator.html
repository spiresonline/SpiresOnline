<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spires Online - Robust Forge</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { background: #0e0e10; color: #ccc; font-family: 'Segoe UI', monospace; text-align: center; }
        
        #controls { 
            background: #18181b; padding: 20px; border-bottom: 2px solid #333; 
            position: sticky; top: 0; z-index: 100;
            display: flex; flex-direction: column; gap: 10px; align-items: center;
        }

        #status-box { 
            background: #000; border: 1px solid #444; padding: 10px; 
            width: 80%; font-size: 0.9rem; color: #00ff88; min-height: 40px;
            display: flex; align-items: center; justify-content: center;
        }

        #grid { 
            display: grid; grid-template-columns: repeat(auto-fill, 64px); gap: 4px; 
            width: 95%; margin: 20px auto; padding-bottom: 50px;
        }
        
        .card { width: 64px; height: 64px; background: #222; border: 1px solid #444; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: contain; }
        .card span { 
            position: absolute; bottom: 0; left: 0; width: 100%; 
            font-size: 8px; background: rgba(0,0,0,0.8); color: white;
        }

        button { padding: 10px 30px; font-weight: bold; background: #d32f2f; color: white; border: none; cursor: pointer; }
        button:disabled { background: #444; cursor: not-allowed; }
        
        input[type="number"] { padding: 5px; width: 60px; background: #222; color: white; border: 1px solid #555; }
    </style>
</head>
<body>

    <div id="controls">
        <h2 style="margin:5px; color:#d32f2f;">ROBUST ASSET FORGE</h2>
        
        <div style="display:flex; gap: 10px; align-items: center;">
            <label>Batch Size:</label>
            <input type="number" id="batch-limit" value="50">
            <button id="btn-run" onclick="startProcess()">SCAN & FORGE</button>
            <button id="btn-dl" disabled onclick="downloadZip()">DOWNLOAD ZIP</button>
        </div>

        <div id="status-box">Waiting to Scan Databases...</div>
    </div>

    <div id="grid"></div>

    <script type="module">
        const ASSETS = {};
        
        // --- 1. THE FILES TO SCAN ---
        const DB_FILES = [
            'data/Items.csv', 
            'data/Equipment.csv', 
            'data/Monsters.csv', 
            'data/Maps.csv', 
            'data/Skills.csv',
            'data/Perks.csv'
        ];

        // --- 2. STYLE SETTINGS (Applied to everything) ---
        // Removed "pixel art, 64-bit" here to let the prompt handle it more naturally
        const AI_STYLE = "isometric view, game sprite, detailed, dark fantasy, white background";

        window.startProcess = async () => {
            const btnRun = document.getElementById('btn-run');
            const btnDl = document.getElementById('btn-dl');
            const status = document.getElementById('status-box');
            const grid = document.getElementById('grid');
            const limit = parseInt(document.getElementById('batch-limit').value) || 20;

            btnRun.disabled = true;
            btnDl.disabled = true;
            grid.innerHTML = "";
            
            // --- STEP A: SCANNING ---
            status.innerText = "Scanning CSV Files...";
            let queue = [];

            // --- >>> UPDATED MANUAL ESSENTIALS <<< ---
            // Specific prompts to ensure correct gender and perspective
            queue.push({ 
                id: "player_male", 
                prompt: "full body male adventurer character sprite, standing pose, holding a sword, isometric view, fantasy armor, pixel art" 
            });
            queue.push({ 
                id: "player_female", 
                prompt: "full body female adventurer character sprite, standing pose, holding a staff, isometric view, fantasy leather armor, pixel art" 
            });
            queue.push({ id: "cursor", prompt: "neon cyan square cursor interface frame ui, pixel art" });

            for (let url of DB_FILES) {
                try {
                    status.innerText = `Reading ${url}...`;
                    let response = await fetch(url);
                    if (!response.ok) throw new Error("File not found");
                    
                    let text = await response.text();
                    let rows = parseCSV(text);
                    
                    let foundCount = 0;
                    rows.forEach(row => {
                        if (row.ID && row.Name) {
                            // Add "pixel art" to database items automatically
                            queue.push({ 
                                id: row.ID, 
                                prompt: `pixel art icon of ${row.Name} ${row.Type || ''}` 
                            });
                            foundCount++;
                        }
                    });
                    console.log(`Loaded ${foundCount} items from ${url}`);

                } catch (e) {
                    console.warn(`Skipped ${url}: ${e.message}`);
                }
            }

            // Remove duplicates
            const uniqueQueue = Array.from(new Map(queue.map(item => [item.id, item])).values());
            
            // Apply Batch Limit
            let batch = uniqueQueue.slice(0, limit);
            status.innerText = `Queue Built: ${batch.length} items. Starting AI...`;

            // --- STEP B: GENERATION LOOP ---
            for(let i=0; i<batch.length; i++) {
                let item = batch[i];
                status.innerHTML = `Generating <b>${item.id}</b> (${i+1}/${batch.length})`;

                try {
                    let imgData = await generateImage(item);
                    ASSETS[item.id] = imgData;
                    addCard(item.id, imgData);
                } catch(err) {
                    console.error("Failed:", item.id);
                    let fallback = createFallback(item.id);
                    ASSETS[item.id] = fallback;
                    addCard(item.id, fallback);
                }

                window.scrollTo(0, document.body.scrollHeight);
                // 2.5 second delay for politeness
                await new Promise(r => setTimeout(r, 2500));
            }

            status.innerText = "Job Complete.";
            status.style.color = "#00ff88";
            btnRun.disabled = false;
            btnDl.disabled = false;
        };

        window.downloadZip = () => {
            let zip = new JSZip();
            let folder = zip.folder("assets");
            for(let id in ASSETS) {
                folder.file(id + ".png", ASSETS[id].split(',')[1], {base64: true});
            }
            zip.generateAsync({type:"blob"}).then(c => saveAs(c, "SpiresOnline_Assets.zip"));
        };

        // --- HELPERS ---

        function generateImage(item) {
            return new Promise((resolve, reject) => {
                // Combine specific prompt with general style
                const prompt = encodeURIComponent(`${item.prompt}, ${AI_STYLE}`);
                const seed = Math.floor(Math.random() * 99999);
                const url = `https://pollinations.ai/p/${prompt}?width=64&height=64&seed=${seed}&nologo=true`;

                let img = new Image();
                img.crossOrigin = "Anonymous";
                
                let timer = setTimeout(() => { img.src=""; reject("Timeout"); }, 12000); // 12s timeout

                img.onload = () => {
                    clearTimeout(timer);
                    let c = document.createElement('canvas');
                    c.width=64; c.height=64;
                    let ctx = c.getContext('2d');
                    ctx.drawImage(img,0,0);
                    removeWhite(ctx);
                    resolve(c.toDataURL("image/png"));
                };
                
                img.onerror = () => {
                    clearTimeout(timer);
                    reject("Network Error");
                };

                img.src = url;
            });
        }

        function removeWhite(ctx) {
            let d = ctx.getImageData(0,0,64,64);
            let p = d.data;
            for(let i=0; i<p.length; i+=4) {
                // Stricter white removal to catch light gray artifacts
                if(p[i]>220 && p[i+1]>220 && p[i+2]>220) p[i+3]=0;
            }
            ctx.putImageData(d,0,0);
        }

        function createFallback(text) {
            let c = document.createElement('canvas');
            c.width=64; c.height=64;
            let ctx = c.getContext('2d');
            ctx.fillStyle="#333"; ctx.fillRect(0,0,64,64);
            ctx.fillStyle="red"; ctx.font="8px monospace"; 
            ctx.fillText(text.substring(0,8), 2, 35);
            return c.toDataURL();
        }

        function addCard(id, data) {
            let div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<img src="${data}"><span>${id}</span>`;
            document.getElementById('grid').appendChild(div);
        }

        function parseCSV(text) {
            let lines = text.split('\n').filter(l => l.trim().length > 0);
            if (lines.length < 2) return [];
            let separator = lines[0].includes('\t') ? '\t' : ',';
            let headers = lines[0].split(separator).map(h => h.trim().replace(/"/g, ''));
            let result = [];
            for (let i = 1; i < lines.length; i++) {
                let rowStr = lines[i];
                let cols = rowStr.match(/(".*?"|[^",\t]+)(?=\s*,|\s*\t|\s*$)/g);
                if (!cols) cols = rowStr.split(separator);
                if (cols.length > 0) {
                    let obj = {};
                    headers.forEach((h, index) => {
                        let val = cols[index] || "";
                        obj[h] = val.replace(/"/g, '').trim();
                    });
                    result.push(obj);
                }
            }
            return result;
        }
    </script>
</body>
</html>