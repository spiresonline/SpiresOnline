<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spires Online - Asset Generator 2.0</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body { background: #1a1a1a; color: #eee; font-family: monospace; display: flex; flex-direction: column; align-items: center; }
        #canvas-container { display: flex; flex-wrap: wrap; gap: 5px; padding: 20px; justify-content: center; width: 90%; }
        .sprite-card { background: #222; border: 1px solid #444; width: 64px; text-align: center; }
        .sprite-card img { width: 32px; height: 32px; margin-top: 5px; image-rendering: pixelated; }
        .sprite-card div { font-size: 9px; color: #888; overflow: hidden; white-space: nowrap; }
        button { padding: 10px 20px; font-size: 1.2rem; background: #4caf50; color: white; border: none; cursor: pointer; margin: 20px; }
    </style>
</head>
<body>
    <h1>Asset Generator 2.0 (18-DB Support)</h1>
    <button id="btn-download" disabled>Generate & Download</button>
    <div id="status">Waiting for local server...</div>
    <div id="canvas-container"></div>

    <script type="module">
        // Config: What files generate visual assets?
        const ASSET_SOURCES = [
            { url: 'data/Items.csv', type: 'Item' },
            { url: 'data/Equipment.csv', type: 'Item' },
            { url: 'data/Monsters.csv', type: 'Monster' },
            { url: 'data/Skills.csv', type: 'Skill' },
            { url: 'data/Perks.csv', type: 'Perk' },
            { url: 'data/Talents.csv', type: 'Talent' }
        ];

        const ASSETS = {}; // Stores base64 images

        window.addEventListener('load', async () => {
            const status = document.getElementById('status');
            const container = document.getElementById('canvas-container');
            const btn = document.getElementById('btn-download');

            status.innerText = "Loading Data...";
            
            try {
                for(let src of ASSET_SOURCES) {
                    let txt = await fetch(src.url).then(r => r.text());
                    let rows = parseCSV(txt);
                    
                    rows.forEach(row => {
                        if(!row.ID) return;
                        
                        // Generate Art
                        let canvas = document.createElement('canvas');
                        canvas.width = 32; canvas.height = 32;
                        let ctx = canvas.getContext('2d');
                        drawAsset(ctx, row, src.type);
                        
                        let data = canvas.toDataURL("image/png");
                        ASSETS[row.ID] = data;

                        // UI Preview
                        let card = document.createElement('div');
                        card.className = 'sprite-card';
                        let img = document.createElement('img');
                        img.src = data;
                        let lbl = document.createElement('div');
                        lbl.innerText = row.ID;
                        card.appendChild(img);
                        card.appendChild(lbl);
                        container.appendChild(card);
                    });
                }
                status.innerText = "Done! " + Object.keys(ASSETS).length + " assets generated.";
                btn.disabled = false;
            } catch(e) {
                status.innerText = "Error: " + e.message + " (Check Local Server!)";
            }

            btn.onclick = () => {
                let zip = new JSZip();
                let folder = zip.folder("assets");
                for(let id in ASSETS) folder.file(id + ".png", ASSETS[id].split(',')[1], {base64:true});
                zip.generateAsync({type:"blob"}).then(c => saveAs(c, "SpiresOnline_Assets.zip"));
            };
        });

        function parseCSV(text) {
            let lines = text.split('\n');
            // Skip empty start lines
            let i=0; while(lines[i] && lines[i].replace(/,/g,'').trim() === '') i++;
            let delimiter = lines[i].includes('\t') ? '\t' : ',';
            let headers = lines[i].split(delimiter).map(h=>h.trim());
            // Skip empty first header col
            let offset = headers[0] === "" ? 1 : 0;
            let res = [];
            for(let j=i+1; j<lines.length; j++) {
                if(!lines[j].trim()) continue;
                let cols = splitCSV(lines[j], delimiter);
                let obj = {};
                headers.slice(offset).forEach((h, idx) => obj[h] = cols[idx+offset]);
                res.push(obj);
            }
            return res;
        }

        function splitCSV(str, d) {
            if(d === '\t') return str.split('\t');
            return (str.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || str.split(',')).map(s => s.replace(/"/g, ''));
        }

        function drawAsset(ctx, data, type) {
            let id = data.ID.toLowerCase();
            let color = '#777';
            
            // Logic for colors
            if(type === 'Monster') color = '#d32f2f'; // Red
            else if(type === 'Skill') color = '#1976d2'; // Blue
            else if(type === 'Perk') color = '#ff9800'; // Orange
            else if(type === 'Talent') color = '#9c27b0'; // Purple
            else if(id.includes('gold') || id.includes('leg')) color = '#ffd700'; // Gold Item
            else if(id.includes('junk')) color = '#8d6e63'; // Brown

            // Draw Background
            ctx.fillStyle = color;
            ctx.fillRect(4, 4, 24, 24);
            
            // Draw Letter Overlay
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 16px monospace';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            let letter = (data.Name ? data.Name[0] : id[0]).toUpperCase();
            ctx.fillText(letter, 16, 16);
            
            // Border
            ctx.strokeStyle = 'rgba(0,0,0,0.5)';
            ctx.lineWidth = 2;
            ctx.strokeRect(4, 4, 24, 24);
        }
    </script>
</body>
</html>